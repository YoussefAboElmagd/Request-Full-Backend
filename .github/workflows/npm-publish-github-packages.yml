name: Deploy Node.js App to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Deploy to VPS via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸ“ Creating or accessing app folder..."
          mkdir -p /home/${{ secrets.USERNAME }}/apps/RequestCiCd
          cd /home/${{ secrets.USERNAME }}/apps/RequestCiCd || exit 1

          echo "ğŸ§¹ Cleaning up working directory..."
          if [ -d ".git" ]; then
            git fetch origin main || exit 1
            git checkout main || exit 1
            git reset --hard origin/main || exit 1
            echo "ğŸ“¥ Code updated to latest main branch."
          else
            echo "ğŸ“¥ Cloning repository..."
            rm -rf ./* ./.*
            git clone --branch main https://github.com/YoussefAboElmagd/Request-Full-Backend.git . || exit 1
          fi

          echo "ğŸ“¦ Installing dependencies..."
          npm install --omit=dev || exit 1

          echo "âš™ï¸ Setting up environment..."
          cat > .env << EOF
          PORT=8020
          DB_URI=${{ secrets.DB_URI }}
          ANOTHER_SECRET=${{ secrets.ANOTHER_SECRET }}
          EOF

          echo "ğŸš€ Starting/Restarting PM2..."
          npm install -g pm2
          pm2 describe RequestCiCd > /dev/null 2>&1 \
            && (echo "ğŸ”„ Restarting existing PM2 process..." && pm2 restart RequestCiCd) \
            || (echo "â–¶ï¸ Starting new PM2 process..." && pm2 start server.js --name RequestCiCd)

          pm2 save
          pm2 list

          echo "âœ… Deployment complete."
