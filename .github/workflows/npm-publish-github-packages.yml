name: Deploy Node.js App to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: 22
          script: |
            echo "Starting deployment..."

            # Create app folder if not exists
            mkdir -p /home/${{ secrets.USERNAME }}/apps/RequestCiCd
            cd /home/${{ secrets.USERNAME }}/apps/RequestCiCd || exit 1

            # If not a git repo, clone fresh
            if [ ! -d ".git" ]; then
              echo "Cloning repo..."
              rm -rf *
              git clone https://github.com/YoussefAboElmagd/Request-Full-Backend.git . || exit 1
            else
              echo "Pulling latest code..."
              git reset --hard
              git pull origin main || exit 1
            fi

            # Install Node modules
            echo "Installing dependencies..."
            npm install --omit=dev || exit 1

            # Restart using PM2
            echo "Restarting PM2..."
            pm2 describe RequestCiCd > /dev/null 2>&1 \
              && pm2 restart RequestCiCd \
              || pm2 start server.js --name RequestCiCd -- --port 8020

            pm2 save

            echo "âœ… Deployment done"
